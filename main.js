(()=>{"use strict";class t{constructor(t){this.conteiner=t,this.chat=null,this.formListeners=[],this.changeListeners=[],this.popup=null,this.inputListeners=[]}init(){this.drawPopup().addEventListener("submit",(t=>this.onSubmitForm(t)))}static addTagHTML(t,e=null,s="div"){const i=document.createElement(s);return i.classList.add(e),t.append(i),i}drawPopup(){this.popup=t.addTagHTML(this.conteiner,"background-popup");const e=t.addTagHTML(this.popup,"popup-input-user","form");e.setAttribute("novalidate","");t.addTagHTML(e,"popup-title").textContent="Выберите псевдоним";const s=t.addTagHTML(e,"popup-input","input");s.setAttribute("required",""),s.setAttribute("name","user"),s.focus(),s.addEventListener("input",(t=>this.onInputValue(t)));const i=t.addTagHTML(e,"popup-button","button");return i.textContent="Продолжить",i.type="Submit",e}drawChat(){this.conteiner.classList.add("chat"),t.addTagHTML(this.conteiner,"chat-names");const e=t.addTagHTML(this.conteiner,"chat-content");this.chat=t.addTagHTML(e,"chat-text","div");const s=t.addTagHTML(e,"chat-input","input");return s.setAttribute("placeholder","Type your message here"),s.addEventListener("change",(t=>this.onChangeChat(t))),s.focus(),!0}drawUser(e,s){const i=this.conteiner.querySelector(".chat-names"),o=t.addTagHTML(i,"user-conteiner");t.addTagHTML(o,"user-avatar");t.addTagHTML(o,"user-name").textContent=s,o.setAttribute("id",e)}drawMessage(e){const s=t.addTagHTML(this.chat,"message");t.addTagHTML(s,"message-title").textContent=`${e.name}, ${e.create}`;return t.addTagHTML(s,"message-text").textContent=e.message,s}static colorName(t){document.getElementById(t).classList.add("curentUser")}onSubmitForm(t){t.preventDefault(),this.formListeners.forEach((e=>e.call(null,t)))}addFormListeners(t){this.formListeners.push(t)}onInputValue(t){t.preventDefault(),this.inputListeners.forEach((t=>t.call(null)))}addInputListeners(t){this.inputListeners.push(t)}onChangeChat(t){t.preventDefault(),this.changeListeners.forEach((e=>e.call(null,t)))}addChangeListeners(t){this.changeListeners.push(t)}}class e{constructor(){this._tooltips=[]}showTooltip(t,e){const s=document.createElement("div");s.classList.add("form-error"),s.textContent=t;const i=document.createElement("div");i.classList.add("arrow"),s.append(i),document.body.appendChild(s);const o=performance.now();this._tooltips.push({id:o,element:s});const a=e.offsetLeft+e.offsetWidth/2-s.offsetWidth/2;s.style.left=`${a}px`;const n=e.offsetTop-s.offsetHeight-8;s.style.top=`${n}px`;const r=s.offsetWidth/2-i.offsetWidth/2;return i.style.left=`${r}px`,o}removeTooltip(t){this._tooltips.find((e=>e.id===t)).element.remove(),this._tooltips=this._tooltips.filter((e=>e.id!==t))}}const s={user:{valueMissing:"Укажите свой псевдоним!",doubleName:"Такое имя уже используется!"}};class i{constructor(t,s){this.editor=t,this.urlServer=s,this.toolTip=new e,this.actualMessages=[],this.id=null,this.ws=new WebSocket("wss://javascript-21-websockets-backend.onrender.com"),this.createChat=!1}init(){this.editor.init(),this.editor.addFormListeners(this.onSubmitForm.bind(this)),this.editor.addInputListeners(this.onInputValue.bind(this)),this.editor.addChangeListeners(this.onChangeChat.bind(this)),this.ws.addEventListener("open",(t=>{console.log(t),console.log("ws open")})),this.ws.addEventListener("close",(t=>{console.log(t),console.log("ws close")})),this.ws.addEventListener("error",(t=>{console.log(t),console.log("ws error")})),this.ws.addEventListener("message",(t=>{console.log(t);const e=JSON.parse(t.data);if("connect"!==e.status)if("addUser"!==e.status)if("delete"!==e.status){if("message"===e.status&&this.createChat){const t=e.body,s=i.getNewFormatDate(t.create);t.create=s;const o=this.editor.drawMessage(t);e.body.id===this.id&&o.classList.add("owner"),this.editor.chat.scrollTop=this.editor.chat.scrollHeight}}else{const t=document.getElementById(e.body.id);t&&t.remove()}else{if(e.body.id===this.id||!this.createChat)return;this.editor.drawUser(e.body.id,e.body.name)}else this.id=e.body.id}))}async onSubmitForm(t){const{elements:e}=t.target;if([...e].some((t=>{const e=i.getError(t);return!!e&&(this.showTooltip(e,t),t.focus(),!0)})),!t.target.checkValidity())return;const o=`${this.urlServer}/addUser/`,a=new FormData(t.target);a.append("id",this.id);const n=await fetch(o,{method:"POST",body:a}),r=await n.json();if(201===n.status){this.editor.popup.remove(),this.editor.popup=null,this.createChat=this.editor.drawChat();for(const t of r.array)t.name&&this.editor.drawUser(t.id,t.name),t.id===this.id&&(this.editor.constructor.colorName(t.id),this.ws.send(JSON.stringify({id:t.id,name:t.name})));for(const t of r.meassages)this.editor.drawMessage(t);this.editor.chat.scrollTop=this.editor.chat.scrollHeight}if("имя занято"===r.status){const t=[...e].find((t=>"user"===t.name));this.showTooltip(s.user.doubleName,t)}}onChangeChat(t){const e={id:this.id,message:t.target.value};this.ws.send(JSON.stringify(e));const{target:s}=t;s.value=""}showTooltip(t,e){this.actualMessages.push({name:e.name,id:this.toolTip.showTooltip(t,e)})}static getError(t){const e=Object.keys(ValidityState.prototype).find((e=>!!t.name&&("valid"!==e&&t.validity[e])));return!!e&&s[t.name][e]}onInputValue(){this.actualMessages.forEach((t=>{this.toolTip.removeTooltip(t.id)})),this.actualMessages=[]}static _addZero(t){let e=t;return e<10&&(e=`0${e}`),e}static getNewFormatDate(t){const e=new Date(t),s=String(e.getFullYear()),o=i._addZero(e.getMonth()),a=i._addZero(e.getDate());return`${i._addZero(e.getHours())}:${i._addZero(e.getMinutes())} ${a}.${o}.${s}`}}const o=document.querySelector(".conteiner"),a=new t(o);new i(a,"https://javascript-21-websockets-backend.onrender.com").init()})();